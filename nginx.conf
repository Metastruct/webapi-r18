
location /lsapi {
	set $_url "";
	lua_code_cache off;
	default_type text/html;
	content_by_lua_file scripts/lsapi/server.lua;
	#lua_socket_log_errors off;
	#proxy_buffering off;
	#gzip off;
	#add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';

			
			
	if ($request_method = 'OPTIONS') {
		add_header 'Access-Control-Allow-Origin' '*';
		add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
		#
		# Custom headers and headers various browsers *should* be OK with but aren't
		#
		add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
		#
		# Tell client that this pre-flight info is valid for 20 days
		#
		add_header 'Access-Control-Max-Age' 1728000;
		add_header 'Content-Type' 'text/plain; charset=utf-8';
		add_header 'Content-Length' 0;
		return 204;
	}
	if ($request_method = 'POST') {
		add_header 'Access-Control-Allow-Origin' '*';
		add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
		add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
		add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
	}
	if ($request_method = 'GET') {
		add_header 'Access-Control-Allow-Origin' '*';
		add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
		add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
		add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
	}
	
}


location @image_server {
	lua_code_cache off;
	content_by_lua_file "scripts/lsapi/serve_image.lua";
}

location ~ ^/lsapi/i/(?<path>[0-9][0-9]*)\.jpg$ {
	lua_code_cache off;
	root /home/srcds/fastdl/lsapi/cache;
	try_files /$path.jpg @image_server;
}
